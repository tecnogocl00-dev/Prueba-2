<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprobante ICE KING</title>
    <!-- Carga de Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1D4ED8',
                        'secondary-gray': '#F3F4F6',
                        'ice-blue': '#BFDBFE',
                        'brand-color': '#06B6D4', /* Nuevo color para ICE KING */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos personalizados para la tipograf√≠a y el espaciado en m√≥viles */
        body {
            background-color: #E5E7EB; /* Fondo suave */
            font-family: 'Inter', sans-serif;
            padding: 1rem;
        }
        /* Estilo para simular el comprobante impreso o digital */
        .receipt-card {
            border: 3px solid #06B6D4; /* Borde m√°s llamativo con el color de la marca */
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            background-color: white;
            padding: 2rem;
            padding-bottom: 4rem; /* Padding extra como seguridad contra el corte */
            margin-top: 1.5rem;
            transform: scale(1); /* Asegura que la captura se vea bien */
        }
        /* Estilo para la animaci√≥n del bot√≥n de descarga */
        .download-button:hover {
            animation: pulse-shadow 1s infinite;
        }
        @keyframes pulse-shadow {
            0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(6, 182, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center">

    <!-- Contenedor Principal y Panel de Entrada -->
    <div class="w-full max-w-sm mx-auto p-4 bg-white rounded-xl shadow-lg border border-gray-200">
        <h1 class="text-xl font-bold text-center text-brand-color mb-4">üßä ICE KING - Generador de Boletas</h1>

        <!-- Campo de Kilos -->
        <div class="mb-4">
            <label for="kilosInput" class="block text-sm font-medium text-gray-700 mb-1">
                1. Kilos de Hielo a Vender
            </label>
            <input type="number" id="kilosInput" placeholder="Solo n√∫meros enteros" min="1" step="1" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-brand-color focus:border-brand-color transition duration-150"
                   value="1">
            <p id="error-message" class="text-red-500 text-xs mt-1 hidden">Por favor, ingrese una cantidad v√°lida (solo n√∫meros enteros).</p>
        </div>

        <!-- Campo de Fecha (Nuevo) -->
        <div class="mb-6">
            <label for="dateInput" class="block text-sm font-medium text-gray-700 mb-1">
                2. Fecha del Comprobante
            </label>
            <input type="date" id="dateInput" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-brand-color focus:border-brand-color transition duration-150">
        </div>
        
        <!-- Bot√≥n de Generaci√≥n -->
        <button onclick="generateReceipt()"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
            3. Generar Comprobante
        </button>
    </div>

    <!-- √Årea del Comprobante (Dise√±ada para ser capturada/screenshot) -->
    <div id="receiptContainer" class="hidden w-full max-w-sm mx-auto receipt-card mt-6">
        <!-- El contenido ser√° insertado aqu√≠ por JavaScript -->
    </div>
    
    <!-- Botones de Descarga -->
    <div id="downloadArea" class="hidden w-full max-w-sm mx-auto mt-4 space-y-3 sm:space-y-0 sm:flex sm:gap-3">
        <button id="downloadButtonPng" onclick="downloadReceiptImage()"
                class="download-button w-full sm:w-1/2 bg-brand-color hover:bg-cyan-600 text-white font-bold py-3 rounded-xl transition duration-300 shadow-xl border-b-4 border-cyan-700">
            ‚¨áÔ∏è Descargar Imagen (PNG)
        </button>
        <button id="downloadButtonPdf" onclick="downloadReceiptPdf()"
                class="download-button w-full sm:w-1/2 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-xl border-b-4 border-red-800">
            ‚¨áÔ∏è Descargar PDF
        </button>
    </div>

    <!-- Carga de las librer√≠as al final del body para la m√°xima estabilidad de carga -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="text/javascript">
        // Constantes del negocio (Precio y Datos de Transferencia)
        const PRICE_PER_KILO = 400; // Valor del kilo de hielo en CLP
        const ACCOUNT_DETAILS = {
            name: "Geraldine Abarza Hern√°ndez",
            rut: "18.763.476-8",
            type: "Cuenta RUT"
        };
        const CURRENCY_FORMAT = new Intl.NumberFormat('es-CL', {
            style: 'currency',
            currency: 'CLP',
            minimumFractionDigits: 0
        });

        // Funci√≥n de inicializaci√≥n
        function initApp() {
            try {
                const dateInput = document.getElementById('dateInput');
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
                generateReceipt(); // Generar un comprobante inicial
            } catch (error) {
                console.error("Error cr√≠tico en la inicializaci√≥n:", error);
                // Si hay un error, al menos mostramos un mensaje en el √°rea de descarga.
                const downloadArea = document.getElementById('downloadArea');
                if (downloadArea) {
                    downloadArea.innerHTML = '<p class="text-red-600 text-center font-bold">Error al iniciar la aplicaci√≥n. Revise su conexi√≥n o entorno.</p>';
                    downloadArea.classList.remove('hidden');
                }
            }
        }

        // Ejecutar la inicializaci√≥n una vez que el DOM est√© completamente cargado.
        document.addEventListener('DOMContentLoaded', initApp);


        /**
         * Funci√≥n principal para calcular el total y generar el HTML del comprobante.
         */
        function generateReceipt() {
            const inputElement = document.getElementById('kilosInput');
            const dateInput = document.getElementById('dateInput');
            const errorMessage = document.getElementById('error-message');
            const receiptContainer = document.getElementById('receiptContainer');
            const downloadArea = document.getElementById('downloadArea');
            
            // Limpiar errores previos
            errorMessage.classList.add('hidden');
            inputElement.classList.remove('border-red-500');

            const kilos = parseInt(inputElement.value, 10);
            const selectedDate = dateInput.value;

            // Validaci√≥n de entrada
            if (isNaN(kilos) || kilos <= 0) {
                errorMessage.textContent = "Por favor, ingrese una cantidad v√°lida de kilos (solo n√∫meros enteros positivos).";
                errorMessage.classList.remove('hidden');
                inputElement.classList.add('border-red-500');
                receiptContainer.classList.add('hidden');
                downloadArea.classList.add('hidden');
                return;
            }

            // 1. C√°lculo del total
            const totalAmount = kilos * PRICE_PER_KILO;

            // 2. Formateo de la fecha (sin hora ni folio)
            let dateStr = 'Fecha no definida';
            if (selectedDate) {
                const parts = selectedDate.split('-'); // [YYYY, MM, DD]
                const dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                dateStr = dateObj.toLocaleDateString('es-CL', { 
                    year: 'numeric', month: 'long', day: 'numeric' 
                });
            }

            // 3. Generaci√≥n del contenido HTML del comprobante
            receiptContainer.innerHTML = `
                <!-- Encabezado del Comprobante -->
                <div class="text-center pb-4 border-b border-dashed border-gray-300">
                    <p class="text-xs font-semibold text-gray-500">COMPROBANTE DE VENTA</p>
                    <h2 class="text-4xl font-extrabold text-brand-color">üßä ICE KING</h2>
                    <p class="text-sm font-semibold text-gray-600 mt-2">
                        Fecha: <span class="text-gray-900">${dateStr}</span>
                    </p>
                </div>

                <!-- Detalles de la Transacci√≥n -->
                <div class="py-4 border-b border-dashed border-gray-300">
                    <p class="flex justify-between font-semibold text-lg mb-2">
                        <span>Descripci√≥n</span>
                        <span>Total</span>
                    </p>
                    <div class="flex justify-between text-gray-700 border-t pt-2 border-gray-100">
                        <span class="text-base font-medium text-gray-600">${kilos} Kilos de Hielo</span>
                        <span class="text-xl font-bold">${CURRENCY_FORMAT.format(totalAmount)}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 text-right">
                        Precio Unitario: ${CURRENCY_FORMAT.format(PRICE_PER_KILO)} por kilo.
                    </p>
                </div>
                
                <!-- Total a Pagar -->
                <div class="pt-4 flex justify-between items-center bg-ice-blue rounded-lg p-4">
                    <span class="text-xl font-bold text-gray-800">TOTAL A PAGAR</span>
                    <span class="text-4xl font-extrabold text-green-700">${CURRENCY_FORMAT.format(totalAmount)}</span>
                </div>

                <!-- Recordatorio de Datos de Transferencia y de Env√≠o del Comprobante (Dirigido al Cliente) -->
                <div class="mt-6 p-4 bg-secondary-gray rounded-xl border border-gray-300">
                    <h3 class="text-lg font-bold text-primary-blue mb-3 border-b pb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        Datos para Transferencia
                    </h3>
                    <div class="space-y-1 text-sm text-gray-700">
                        <p>
                            <span class="font-semibold">Nombre:</span> ${ACCOUNT_DETAILS.name}
                        </p>
                        <p>
                            <span class="font-semibold">RUT:</span> ${ACCOUNT_DETAILS.rut}
                        </p>
                        <p>
                            <span class="font-semibold">Tipo de Cuenta:</span> ${ACCOUNT_DETAILS.type}
                        </p>
                    </div>

                    <!-- Recordatorio de ENV√çO AL CLIENTE -->
                    <div class="mt-4 p-2 bg-yellow-100 rounded-lg border border-yellow-300 text-center">
                        <p class="text-sm font-extrabold text-yellow-800">
                            ¬°IMPORTANTE!
                        </p>
                        <p class="text-sm font-semibold text-gray-800">
                            Tras realizar la transferencia, por favor, env√≠e su comprobante de pago a trav√©s de WhatsApp.
                        </p>
                    </div>

                </div>
                
                <!-- Pie de p√°gina -->
                <p class="text-center text-xs text-gray-500 mt-4 pt-4 border-t border-gray-200">
                    ¬°Gracias por preferir ICE KING! ‚ùÑÔ∏è
                </p>
            `;

            // Mostrar el contenedor del recibo y el √°rea de descarga
            receiptContainer.classList.remove('hidden');
            downloadArea.classList.remove('hidden');
        }

        /**
         * Funci√≥n central para generar el canvas (imagen) del comprobante.
         * Aplica un buffer para evitar recortes.
         */
        async function getReceiptCanvas() {
            const receiptContainer = document.getElementById('receiptContainer');
            const receiptWidth = receiptContainer.offsetWidth;
            
            // Buffer de seguridad de 100px para garantizar la captura del pie de p√°gina.
            const heightBuffer = 100; 
            const receiptHeightWithBuffer = receiptContainer.offsetHeight + heightBuffer;

            return await html2canvas(receiptContainer, {
                scale: 3, 
                useCORS: true, 
                backgroundColor: '#FFFFFF',
                // Forzamos las dimensiones de captura con el buffer
                width: receiptWidth,
                height: receiptHeightWithBuffer,
                scrollY: 0, 
                scrollX: 0 
            });
        }

        /**
         * Descarga la imagen del comprobante usando html2canvas (PNG).
         */
        async function downloadReceiptImage() {
            const downloadButton = document.getElementById('downloadButtonPng');
            
            const originalText = downloadButton.innerHTML;
            downloadButton.disabled = true;
            downloadButton.innerHTML = 'Generando Imagen...';

            try {
                if (typeof html2canvas === 'undefined') throw new Error("html2canvas no est√° cargado.");
                
                const canvas = await getReceiptCanvas();
                const image = canvas.toDataURL('image/png');
                
                const link = document.createElement('a');
                link.href = image;
                
                const kilos = document.getElementById('kilosInput').value || '0';
                const dateStr = document.getElementById('dateInput').value;
                link.download = `Comprobante_ICEKING_${kilos}Kg_${dateStr}.png`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("Error al generar la imagen:", error);
                downloadButton.innerHTML = '‚ùå Error al Descargar. Intente de Nuevo';
                setTimeout(() => {
                    downloadButton.innerHTML = originalText;
                    downloadButton.disabled = false;
                }, 3000);
                return;
            } finally {
                if (downloadButton.innerHTML.indexOf('Error') === -1) {
                    downloadButton.innerHTML = originalText;
                    downloadButton.disabled = false;
                }
            }
        }

        /**
         * Descarga el comprobante como un documento PDF usando el canvas previamente generado.
         * **SOLUCI√ìN PROFESIONAL: Usa tama√±o de p√°gina din√°mico para evitar cortes.**
         */
        async function downloadReceiptPdf() {
            const downloadButton = document.getElementById('downloadButtonPdf');
            
            const originalText = downloadButton.innerHTML;
            downloadButton.disabled = true;
            downloadButton.innerHTML = 'Generando PDF...';

            try {
                if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
                    throw new Error("Librer√≠as de PDF no est√°n cargadas.");
                }

                // Obtener el canvas completo (incluyendo el buffer de seguridad)
                const canvas = await getReceiptCanvas();
                const imgData = canvas.toDataURL('image/png');
                
                // 1. Calcular las dimensiones de la imagen en base al tama√±o del canvas
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                
                const margin = 10; // 10mm de margen
                const standardDpi = 72;
                
                // 2. Determinar la escala de conversi√≥n de p√≠xeles (px) a mil√≠metros (mm)
                // Conversi√≥n de p√≠xeles del canvas a mil√≠metros del PDF (aproximada, basada en el ancho A4 est√°ndar)
                const pdfWidthMM = 210; // Ancho A4
                const imgWidthMM = pdfWidthMM - (2 * margin);
                
                // Usar el aspect ratio del canvas para calcular la altura en mm
                const aspectRatio = canvasHeight / canvasWidth;
                const imgHeightMM = imgWidthMM * aspectRatio;

                // 3. Crear el documento PDF con TAMA√ëO DE P√ÅGINA DIN√ÅMICO
                // La p√°gina se ajusta al tama√±o de la imagen + 20mm de m√°rgenes (10mm arriba/abajo)
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', [imgWidthMM + (2 * margin), imgHeightMM + (2 * margin)]);
                
                // 4. Agregar la imagen al PDF
                const xPos = margin; // Posici√≥n horizontal (margen izquierdo)
                const yPos = margin; // Posici√≥n vertical (margen superior)

                pdf.addImage(imgData, 'PNG', xPos, yPos, imgWidthMM, imgHeightMM);
                
                // 5. Definir nombre del archivo y guardar
                const kilos = document.getElementById('kilosInput').value || '0';
                const dateStr = document.getElementById('dateInput').value;
                const filename = `Comprobante_ICEKING_${kilos}Kg_${dateStr}.pdf`;
                
                pdf.save(filename);

            } catch (error) {
                console.error("Error al generar el PDF:", error);
                downloadButton.innerHTML = '‚ùå Error al Descargar PDF. Intente de Nuevo';
                setTimeout(() => {
                    downloadButton.innerHTML = originalText;
                    downloadButton.disabled = false;
                }, 3000);
                return; 
            } finally {
                if (downloadButton.innerHTML.indexOf('Error') === -1) {
                    downloadButton.innerHTML = originalText;
                    downloadButton.disabled = false;
                }
            }
        }
    </script>
</body>
</html>
